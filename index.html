<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Radar Dashboard (1 coluna + ordenar + descrição)</title>
  <style>
    :root{
      --bg:#0b0f19;
      --card:rgba(255,255,255,.04);
      --border:rgba(255,255,255,.08);
      --muted:#a9b7d6;
      --text:#e8eefc;
      --link:#7fb0ff;
      --pill:#bcd0ff;
      --warn:#ff9ea8;
    }
    *{box-sizing:border-box;}
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background:var(--bg); color:var(--text); }
    header { padding: 16px; border-bottom: 1px solid var(--border); }
    h1 { font-size: 16px; margin: 0; letter-spacing:.2px; }
    .sub { font-size: 12px; color: var(--muted); margin-top: 4px; }

    .wrap { padding: 16px; max-width: 1200px; margin: 0 auto; display:flex; flex-direction:column; gap:12px; }

    .topbar{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }

    .pills { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .pill { padding: 6px 10px; border:1px solid rgba(255,255,255,.12); border-radius: 999px; font-size: 12px; color:var(--pill); background:rgba(255,255,255,.03); }
    .pill.warn { border-color: rgba(255,158,168,.45); color:var(--warn); }

    .card { background: var(--card); border:1px solid var(--border); border-radius: 14px; padding: 12px; }
    .muted { color:var(--muted); font-size: 12px; }
    .kpi { font-size: 20px; font-weight: 750; line-height: 1.1; }

    .inputs{
      display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;
      padding-top: 10px;
    }
    label { font-size: 12px; color:var(--muted); display:flex; flex-direction:column; gap:6px; }
    select, input[type="file"] {
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      border-radius: 10px;
      padding: 8px;
      min-width: 180px;
    }
    input[type="file"]{ min-width: 240px; }
    .btn {
      padding: 8px 10px; border-radius: 10px; border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06); color:var(--text); cursor:pointer;
      height: 36px;
    }
    .btn:disabled { opacity:.5; cursor:not-allowed; }

    .kpis{
      display:grid; gap:10px;
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }
    @media (max-width: 900px){
      .kpis{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
      select, input[type="file"]{ min-width: 100%; }
      .btn{ width: 100%; }
      .inputs{ align-items:stretch; }
    }

    .list{
      display:grid; gap:8px;
      margin-top: 8px;
    }
    .listRow{
      display:flex; justify-content:space-between; gap:12px;
      padding: 8px 10px;
      border:1px solid rgba(255,255,255,.08);
      border-radius: 12px;
      background: rgba(255,255,255,.03);
    }
    .badge{
      padding: 2px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      color:var(--pill);
      font-size: 12px;
      white-space: nowrap;
    }

    canvas { width:100%; height: 220px; }

    table { width:100%; border-collapse: collapse; font-size: 12px; }
    th, td { border-bottom:1px solid rgba(255,255,255,.08); padding: 10px 8px; text-align:left; vertical-align: top;}
    th { color:var(--pill); font-weight: 650; position: sticky; top: 0; background: rgba(11,15,25,.95); }
    a { color:var(--link); text-decoration:none; }
    .small{ white-space: nowrap; }
    .titleCell{ min-width: 320px; max-width: 520px; }
    .descCell{ min-width: 280px; max-width: 520px; }
    .truncate{
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .thBtn{
      display:inline-flex; align-items:center; gap:6px;
      cursor:pointer; user-select:none;
    }
    .sortIcon{ opacity:.85; font-size: 11px; }
    .muted2{ color: rgba(169,183,214,.85); font-size: 11px; }
  </style>
</head>
<body>

  <header>
    <div class="topbar">
      <div>
        <h1>Radar Dashboard</h1>
        <div class="sub">Upload (YT/TT/IG) → filtros → Top 25 → ordenar por clique</div>
      </div>

      <div class="pills">
        <span class="pill" id="status">à espera de ficheiros</span>
        <span class="pill" id="counts">YouTube: 0 · TikTok: 0 · Instagram: 0</span>
        <span class="pill warn" id="ytWarning" style="display:none;"></span>
      </div>
    </div>

    <div class="inputs">
      <label>YouTube (CSV/XLSX)
        <input id="fileYT" type="file" accept=".xlsx,.xls,.csv" />
      </label>
      <label>TikTok (CSV/XLSX)
        <input id="fileTT" type="file" accept=".xlsx,.xls,.csv" />
      </label>
      <label>Instagram (CSV/XLSX)
        <input id="fileIG" type="file" accept=".xlsx,.xls,.csv" />
      </label>

      <button class="btn" id="btnLoad">Carregar e Unificar</button>
      <button class="btn" id="btnClear">Limpar</button>

      <label>Plataforma
        <select id="platformFilter"><option value="">Todas</option></select>
      </label>
      <label>Keyword
        <select id="keywordFilter"><option value="">Todas</option></select>
      </label>
      <label>Source
        <select id="sourceFilter"><option value="">Todos</option></select>
      </label>
    </div>
  </header>

  <div class="wrap">

    <div class="kpis">
      <div class="card">
        <div class="kpi" id="kpiRows">0</div>
        <div class="muted">linhas (total)</div>
      </div>
      <div class="card">
        <div class="kpi" id="kpiPlatforms">0</div>
        <div class="muted">plataformas</div>
      </div>
      <div class="card">
        <div class="kpi" id="kpiAuthors">0</div>
        <div class="muted">autores únicos</div>
      </div>
      <div class="card">
        <div class="kpi" id="kpiKeywords">0</div>
        <div class="muted">keywords únicas</div>
      </div>
    </div>

    <div class="card">
      <div class="muted">Volume por dia (collectedAt)</div>
      <canvas id="chart"></canvas>
    </div>

    <div class="card">
      <div class="muted">Top 8 keywords</div>
      <div id="topKeywords" class="list"></div>
    </div>

    <div class="card">
      <div class="muted">Top 10 autores</div>
      <div id="topAuthors" class="list"></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-end;">
        <div>
          <div class="muted">Top 25 posts</div>
          <div class="muted2" id="topInfo">Ordenado por Comments (desc)</div>
        </div>
        <div class="muted2">Clica no cabeçalho para ordenar ▲▼</div>
      </div>

      <div style="overflow:auto; margin-top:8px; border-radius: 12px;">
        <table id="postsTable">
          <thead>
            <tr>
              <th class="small"><span class="thBtn" data-key="source" data-type="text">Source <span class="sortIcon" id="icon-source"></span></span></th>
              <th class="small"><span class="thBtn" data-key="platform" data-type="text">Plataforma <span class="sortIcon" id="icon-platform"></span></span></th>
              <th><span class="thBtn" data-key="title" data-type="text">Título <span class="sortIcon" id="icon-title"></span></span></th>
              <th><span class="thBtn" data-key="author" data-type="text">Autor <span class="sortIcon" id="icon-author"></span></span></th>
              <th class="small"><span class="thBtn" data-key="views" data-type="num">Views <span class="sortIcon" id="icon-views"></span></span></th>
              <th class="small"><span class="thBtn" data-key="likes" data-type="num">Likes <span class="sortIcon" id="icon-likes"></span></span></th>
              <th class="small"><span class="thBtn" data-key="comments" data-type="num">Comments <span class="sortIcon" id="icon-comments"></span></span></th>
              <th><span class="thBtn" data-key="desc" data-type="text">Descrição <span class="sortIcon" id="icon-desc"></span></span></th>
            </tr>
          </thead>
          <tbody id="topPosts"></tbody>
        </table>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

  <script>
    // UI
    const fileYT = document.getElementById('fileYT');
    const fileTT = document.getElementById('fileTT');
    const fileIG = document.getElementById('fileIG');
    const btnLoad = document.getElementById('btnLoad');
    const btnClear = document.getElementById('btnClear');

    const statusEl = document.getElementById('status');
    const countsEl = document.getElementById('counts');
    const ytWarningEl = document.getElementById('ytWarning');
    const topInfoEl = document.getElementById('topInfo');

    const platformFilter = document.getElementById('platformFilter');
    const keywordFilter = document.getElementById('keywordFilter');
    const sourceFilter = document.getElementById('sourceFilter');

    let rawRows = [];
    let currentTopRows = []; // top 25 já filtrado
    let sortState = { key: 'comments', dir: 'desc', type: 'num' };

    // Helpers
    function norm(s){ return (s ?? '').toString().trim(); }
    function toNum(v){
      const n = Number((v ?? '').toString().replace(/[^\d.-]/g,''));
      return Number.isFinite(n) ? n : 0;
    }
    function escapeHtml(str){
      return (str ?? '').toString()
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }
    function keyNorm(k){
      return (k ?? '').toString().toLowerCase().replace(/[^a-z0-9]/g,'');
    }
    function indexRow(r){
      const idx = {};
      for (const k in r){
        const nk = keyNorm(k);
        if(!nk) continue;
        const v = r[k];
        if (idx[nk] === undefined || idx[nk] === null || String(idx[nk]).trim() === ''){
          idx[nk] = v;
        }
      }
      return idx;
    }
    function pickIdx(idx, ...keys){
      for (const k of keys){
        const nk = keyNorm(k);
        const v = idx[nk];
        if (v !== undefined && v !== null && String(v).trim() !== '') return v;
      }
      return '';
    }

    function normalizeUrl(u, source){
      let s = norm(u);
      if(!s) return '';
      s = s.replace(/^"+|"+$/g,'');
      if (s.startsWith('//')) s = 'https:' + s;

      if (s.startsWith('/')){
        if(source === 'TT') s = 'https://www.tiktok.com' + s;
        if(source === 'IG') s = 'https://www.instagram.com' + s;
        if(source === 'YT') s = 'https://www.youtube.com' + s;
      }

      if (!/^https?:\/\//i.test(s)){
        if (s.startsWith('www.')) s = 'https://' + s;
        else if (s.startsWith('tiktok.com')) s = 'https://www.' + s;
        else if (s.startsWith('instagram.com')) s = 'https://www.' + s;
        else if (s.startsWith('youtube.com') || s.startsWith('youtu.be')) s = 'https://' + s;
      }
      return s;
    }

    function buildTikTokUrlIfMissing(idx, currentUrl){
      if(currentUrl) return currentUrl;
      const id = pickIdx(idx, 'id','videoid','awemeid');
      if(!id) return '';
      const user = pickIdx(idx, 'authormetaname','username','author','handle','uniqueid','authoruniqueid');
      if(!user) return '';
      return `https://www.tiktok.com/@${norm(user).replace(/^@/,'')}/video/${norm(id)}`;
    }

    // CSV parser
    function splitCsvLine(line){
      const res = [];
      let cur = '';
      let inQ = false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(ch === '"'){
          if(inQ && line[i+1] === '"'){ cur += '"'; i++; }
          else inQ = !inQ;
        } else if(ch === ',' && !inQ){
          res.push(cur); cur='';
        } else {
          cur += ch;
        }
      }
      res.push(cur);
      return res;
    }
    function csvToRows(csvText){
      const lines = csvText.split(/\r?\n/).filter(l=>l.trim().length>0);
      if(lines.length === 0) return [];
      const headers = splitCsvLine(lines[0]).map(h=>h.trim());
      const out = [];
      for(let i=1;i<lines.length;i++){
        const cols = splitCsvLine(lines[i]);
        const obj = {};
        headers.forEach((h, idx)=> obj[h] = cols[idx] ?? '');
        out.push(obj);
      }
      return out;
    }

    function dayKey(v){
      const s = norm(v);
      if(!s) return '';
      const d = new Date(s);
      if(!isNaN(d.getTime())) return d.toISOString().slice(0,10);
      const m = s.match(/^(\d{1,2})[\/.-](\d{1,2})[\/.-](\d{2,4})/);
      if(m){
        const dd = m[1].padStart(2,'0');
        const mm = m[2].padStart(2,'0');
        const yy = m[3].length===2 ? '20'+m[3] : m[3];
        return `${yy}-${mm}-${dd}`;
      }
      return '';
    }

    function countBy(arr, keyFn){
      const map = new Map();
      for(const item of arr){
        const k = keyFn(item);
        if(!k) continue;
        map.set(k, (map.get(k) || 0) + 1);
      }
      return [...map.entries()].sort((a,b)=>b[1]-a[1]);
    }

    function setSelectOptions(selectEl, values){
      const first = selectEl.options[0];
      selectEl.innerHTML = '';
      selectEl.appendChild(first);
      for (const v of values){
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        selectEl.appendChild(opt);
      }
    }

    function renderList(container, pairs, max=10){
      container.innerHTML = '';
      pairs.slice(0,max).forEach(([name, count])=>{
        const row = document.createElement('div');
        row.className = 'listRow';
        row.innerHTML = `<span>${escapeHtml(name)}</span><span class="badge">${count}</span>`;
        container.appendChild(row);
      });
    }

    function drawChart(canvas, labels, values){
      const ctx = canvas.getContext('2d');
      const w = canvas.width = canvas.clientWidth * devicePixelRatio;
      const h = canvas.height = 220 * devicePixelRatio;
      ctx.clearRect(0,0,w,h);

      const pad = 18 * devicePixelRatio;
      const maxV = Math.max(1, ...values);
      const n = labels.length;

      ctx.globalAlpha = 0.35;
      ctx.strokeStyle = '#ffffff';
      ctx.beginPath();
      ctx.moveTo(pad, h - pad);
      ctx.lineTo(w - pad, h - pad);
      ctx.stroke();
      ctx.globalAlpha = 1;

      if(n === 0) return;

      const barW = (w - 2*pad) / n;
      for(let i=0;i<n;i++){
        const v = values[i];
        const bh = (h - 2*pad) * (v / maxV);
        const x = pad + i*barW + barW*0.1;
        const y = (h - pad) - bh;
        const bw = barW*0.8;

        ctx.fillStyle = 'rgba(127,176,255,0.9)';
        ctx.fillRect(x,y,bw,bh);
      }
    }

    function labelForSource(source){
      if(source === 'YT') return 'YouTube';
      if(source === 'TT') return 'TikTok';
      if(source === 'IG') return 'Instagram';
      return source;
    }

    function normalizeRow(r, source){
      const idx = indexRow(r);

      const author = pickIdx(idx,
        // TikTok
        'authormetaname','authormetanickname',
        // Instagram
        'ownerusername','username','ownerfullname',
        // YouTube + comuns
        'channelname','channeltitle','uploader','uploadername',
        'author','user','handle','account','creator','profilename'
      );

      const title = pickIdx(idx,
        'title','videotitle','name',
        'caption','description','text','content','posttext'
      );

      let urlRaw = pickIdx(idx,
        'url','link','permalink','shareurl',
        'webvideourl','videourl','posturl',
        'watchurl','canonicalurl','shorturl','videolink','videopageurl'
      );

      let url = normalizeUrl(urlRaw, source);
      if(source === 'TT') url = buildTikTokUrlIfMissing(idx, url);

      const views = pickIdx(idx,
        'videoviewcount','videoplaycount',
        'playcount',
        'views','viewcount','plays','impressions'
      );

      const likes = pickIdx(idx,
        'likescount',
        'diggcount',
        'likes','likecount','heartcount','hearts'
      );

      const comments = pickIdx(idx,
        'commentscount',
        'commentcount',
        'comments','comment'
      );

      const publishedAt = pickIdx(idx, 'publishedat','date','createdat','createtime','timestamp','time');
      const keyword = pickIdx(idx, 'keyword','query','search','searchquery') || '';
      const collectedAt = pickIdx(idx, 'collectedat','scrapedat','pulledat') || new Date().toISOString();

      // descrição: tenta primeiro "text/caption/description" (já está no title pick, mas aqui queremos o corpo)
      const desc = pickIdx(idx, 'text','caption','description','content','posttext');

      const hasError = !!pickIdx(idx, 'error','errormessage','status') && String(pickIdx(idx,'error','status')).toLowerCase().includes('not');

      return {
        source,
        platform: labelForSource(source),
        author: norm(author),
        title: norm(title),
        url,
        publishedAt,
        views,
        likes,
        comments,
        desc: norm(desc),
        keyword: norm(keyword),
        collectedAt,
        _hasAboutChannelInfo: !!pickIdx(idx, 'aboutchannelinfochannelname','aboutchannelinfochannelurl','channeltotalvideos'),
        _hasError: hasError
      };
    }

    function isYouTubeChannelOnly(rows){
      if(rows.length === 0) return false;
      let about = 0, videoUrl = 0;
      for(const r of rows){
        if(r._hasAboutChannelInfo) about++;
        if(r.url && (r.url.includes('watch?v=') || r.url.includes('youtu.be/'))) videoUrl++;
      }
      return about > rows.length * 0.6 && videoUrl === 0;
    }

    function parseFile(file, source){
      return new Promise((resolve, reject)=>{
        const ext = file.name.toLowerCase().split('.').pop();
        const reader = new FileReader();

        reader.onload = (e) => {
          try{
            let rows = [];
            if(ext === 'csv'){
              rows = csvToRows(e.target.result);
            } else {
              if(typeof XLSX === 'undefined') throw new Error('XLSX não carregou. Usa CSV.');
              const data = new Uint8Array(e.target.result);
              const wb = XLSX.read(data, {type:'array'});
              const sheetName = wb.SheetNames[0];
              const ws = wb.Sheets[sheetName];
              rows = XLSX.utils.sheet_to_json(ws, {defval: ''});
            }

            const out = rows
              .map(r => normalizeRow(r, source))
              .filter(x => x.url || x.title || x.author || x.desc)
              .filter(x => !x._hasError);

            resolve(out);
          } catch(err){
            reject(err);
          }
        };

        reader.onerror = reject;
        if(ext === 'csv') reader.readAsText(file);
        else reader.readAsArrayBuffer(file);
      });
    }

    // Filtros
    function applyFilters(){
      const p = platformFilter.value;
      const k = keywordFilter.value;
      const s = sourceFilter.value;

      return rawRows.filter(r => {
        const okP = !p || norm(r.platform) === p;
        const okK = !k || norm(r.keyword) === k;
        const okS = !s || norm(r.source) === s;
        return okP && okK && okS;
      });
    }

    function refreshFilters(){
      const allPlatforms = [...new Set(rawRows.map(r=>norm(r.platform)).filter(Boolean))].sort();
      const allKeywords  = [...new Set(rawRows.map(r=>norm(r.keyword)).filter(Boolean))].sort();
      const allSources   = [...new Set(rawRows.map(r=>norm(r.source)).filter(Boolean))].sort();

      setSelectOptions(platformFilter, allPlatforms);
      setSelectOptions(keywordFilter, allKeywords);
      setSelectOptions(sourceFilter, allSources);
    }

    function updateCountsAndWarnings(){
      const counts = { YT: 0, TT: 0, IG: 0 };
      const ytRows = [];
      for(const r of rawRows){
        if(counts[r.source] !== undefined) counts[r.source]++;
        if(r.source === 'YT') ytRows.push(r);
      }
      countsEl.textContent = `YouTube: ${counts.YT.toLocaleString('pt-PT')} · TikTok: ${counts.TT.toLocaleString('pt-PT')} · Instagram: ${counts.IG.toLocaleString('pt-PT')}`;

      if(isYouTubeChannelOnly(ytRows)){
        ytWarningEl.style.display = '';
        ytWarningEl.textContent = 'O CSV do YouTube parece ser “channel info” (aboutChannelInfo), não lista de vídeos. No streamers/youtube-scraper usa startUrls a terminar em /videos.';
      } else {
        ytWarningEl.style.display = 'none';
        ytWarningEl.textContent = '';
      }
    }

    // Sorting
    function clearIcons(){
      const ids = ['source','platform','title','author','views','likes','comments','desc'];
      ids.forEach(id=>{
        const el = document.getElementById('icon-' + id);
        if(el) el.textContent = '';
      });
    }

    function setIcon(key, dir){
      const el = document.getElementById('icon-' + key);
      if(!el) return;
      el.textContent = (dir === 'asc') ? '▲' : '▼';
    }

    function sortRows(rows, key, dir, type){
      const mult = (dir === 'asc') ? 1 : -1;
      const getVal = (r)=>{
        if(key === 'views') return toNum(r.views);
        if(key === 'likes') return toNum(r.likes);
        if(key === 'comments') return toNum(r.comments);
        return norm(r[key] ?? '');
      };

      return [...rows].sort((a,b)=>{
        const A = getVal(a);
        const B = getVal(b);

        if(type === 'num'){
          return (A - B) * mult;
        }
        // text
        return A.localeCompare(B, undefined, { sensitivity:'base' }) * mult;
      });
    }

    function renderTopPosts(rows){
      const tbody = document.getElementById('topPosts');
      tbody.innerHTML = '';

      for(const r of rows){
        const safeUrl = r.url || '';
        const title = norm(r.title) || '(sem título)';
        const author = norm(r.author) || '(sem autor)';
        const desc = norm(r.desc) || '';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="small">${escapeHtml(norm(r.source))}</td>
          <td class="small">${escapeHtml(norm(r.platform))}</td>
          <td class="titleCell">${safeUrl ? `<a href="${escapeHtml(safeUrl)}" target="_blank" rel="noreferrer">${escapeHtml(title)}</a>` : escapeHtml(title)}</td>
          <td>${escapeHtml(author)}</td>
          <td class="small">${toNum(r.views).toLocaleString('pt-PT')}</td>
          <td class="small">${toNum(r.likes).toLocaleString('pt-PT')}</td>
          <td class="small">${toNum(r.comments).toLocaleString('pt-PT')}</td>
          <td class="descCell" title="${escapeHtml(desc)}">
            <div class="truncate">${escapeHtml(desc || '—')}</div>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    function update(){
      const rows = applyFilters();

      document.getElementById('kpiRows').textContent = rows.length.toLocaleString('pt-PT');

      const platforms = new Set(rows.map(r=>norm(r.platform)).filter(Boolean));
      const authors   = new Set(rows.map(r=>norm(r.author)).filter(Boolean));
      const keywords  = new Set(rows.map(r=>norm(r.keyword)).filter(Boolean));

      document.getElementById('kpiPlatforms').textContent = platforms.size.toLocaleString('pt-PT');
      document.getElementById('kpiAuthors').textContent = authors.size.toLocaleString('pt-PT');
      document.getElementById('kpiKeywords').textContent = keywords.size.toLocaleString('pt-PT');

      renderList(document.getElementById('topKeywords'), countBy(rows, r=>norm(r.keyword)), 8);
      renderList(document.getElementById('topAuthors'), countBy(rows, r=>norm(r.author)), 10);

      // Base: Top 25 por comments desc
      currentTopRows = [...rows]
        .sort((a,b)=> (toNum(b.comments)-toNum(a.comments)) || (toNum(b.views)-toNum(a.views)))
        .slice(0,25);

      // Aplica a ordenação atual (por defeito: comments desc)
      const sorted = sortRows(currentTopRows, sortState.key, sortState.dir, sortState.type);
      clearIcons();
      setIcon(sortState.key, sortState.dir);

      topInfoEl.textContent = `Ordenado por ${sortState.key} (${sortState.dir})`;
      renderTopPosts(sorted);

      const byDay = countBy(rows, r=>dayKey(r.collectedAt));
      byDay.sort((a,b)=> a[0].localeCompare(b[0]));
      drawChart(document.getElementById('chart'), byDay.map(x=>x[0]), byDay.map(x=>x[1]));
    }

    // Click handlers (headers)
    document.querySelectorAll('.thBtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const key = btn.getAttribute('data-key');
        const type = btn.getAttribute('data-type');

        if(sortState.key === key){
          sortState.dir = (sortState.dir === 'asc') ? 'desc' : 'asc';
        } else {
          sortState.key = key;
          sortState.dir = (type === 'num') ? 'desc' : 'asc';
          sortState.type = type;
        }

        const sorted = sortRows(currentTopRows, sortState.key, sortState.dir, sortState.type);
        clearIcons();
        setIcon(sortState.key, sortState.dir);
        topInfoEl.textContent = `Ordenado por ${sortState.key} (${sortState.dir})`;
        renderTopPosts(sorted);
      });
    });

    // Eventos
    btnLoad.addEventListener('click', async ()=>{
      const files = [
        { file: fileYT.files?.[0], source: 'YT' },
        { file: fileTT.files?.[0], source: 'TT' },
        { file: fileIG.files?.[0], source: 'IG' }
      ].filter(x => x.file);

      if(files.length === 0){
        alert('Carrega pelo menos 1 ficheiro (YT/TT/IG).');
        return;
      }

      statusEl.textContent = 'a carregar...';
      btnLoad.disabled = true;

      try{
        const parsed = await Promise.all(files.map(x => parseFile(x.file, x.source)));
        rawRows = parsed.flat();

        refreshFilters();
        updateCountsAndWarnings();
        update();

        statusEl.textContent = `ok (${rawRows.length.toLocaleString('pt-PT')} linhas)`;
      } catch(err){
        console.error(err);
        statusEl.textContent = 'erro';
        alert('Erro a ler ficheiros.\n\nDetalhe: ' + (err?.message || err));
      } finally {
        btnLoad.disabled = false;
      }
    });

    btnClear.addEventListener('click', ()=>{
      rawRows = [];
      currentTopRows = [];
      fileYT.value = '';
      fileTT.value = '';
      fileIG.value = '';

      platformFilter.value = '';
      keywordFilter.value = '';
      sourceFilter.value = '';

      sortState = { key: 'comments', dir: 'desc', type: 'num' };
      clearIcons();
      setIcon('comments', 'desc');

      refreshFilters();
      updateCountsAndWarnings();
      update();

      ytWarningEl.style.display = 'none';
      ytWarningEl.textContent = '';
      statusEl.textContent = 'limpo';
    });

    platformFilter.addEventListener('change', update);
    keywordFilter.addEventListener('change', update);
    sourceFilter.addEventListener('change', update);

    (function init(){
      clearIcons();
      setIcon('comments', 'desc');
      refreshFilters();
      updateCountsAndWarnings();
      update();
    })();
  </script>
</body>
</html>
